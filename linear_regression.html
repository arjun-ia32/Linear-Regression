<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="UTF-8" />
        <title>Linear Regression</title>
        <!-- Include Styles -->
        <link rel="stylesheet" href="../../Library/css/bootstrap.min.css" />

        <!-- Include Scripts -->
        <script src="../../Library/js/jquery.min.js"></script>
        <script src="../../Library/js/popper.min.js"></script>
        <script src="../../Library/js/bootstrap.bundle.min.js"></script>
        <script src="../../Library/js/chart.min.js"></script>
        <script src="../../Library/js/papaparse.min.js"></script>
        <script src="../../Library/js/MathJax/es5/tex-chtml.js" id="MathJax-script" async></script>
        <script src="./js/custom.js"></script>

        <style>
            .flex-container {
                display: flex;
                flex-flow: row wrap;
                justify-content: flex-start;
                align-items: center;
            }
        </style>

        <script>
            window.onload = process_on_load;

            function handle_html_table_change(table, td) {
                return function() {
                    //console.log("Change <" + td.innerText + ">");
                    if (td.innerText === "\n") {
                        return;
                    }
                    table.internal_data.values[td.parentElement.rowIndex - 1][td.internal_j] = parseFloat(td.innerText);
                    update_calculated_fields(table);
                    update_table(table);
                    update_display_info(table);
                    update_charts(table);
                }
            }

            function update_calculated_fields(table) {
                let X = table.internal_data.values.map(x => x.x);
                let Y = table.internal_data.values.map(y => y.y);
                let YY = linear_regression_apply(X, Y);

                for (let i = 0; i < table.internal_data.values.length; ++i) {
                    table.internal_data.values[i].yy = YY[i];
                    table.internal_data.values[i].e = Y[i] - YY[i];
                    table.internal_data.values[i].ee = table.internal_data.values[i].e ** 2;
                }
            }

            function update_display_info(table) {
                let X = table.internal_data.values.map(x => x.x);
                let Y = table.internal_data.values.map(y => y.y);
                let E = table.internal_data.values.map(e => e.e);
                let EE = table.internal_data.values.map(e => e.ee);

                document.getElementById("r").innerText = ppmcc(X, Y).toFixed(table.internal_settings.round_threshold);
                document.getElementById("e").innerText = E.sum().toFixed(table.internal_settings.round_threshold);
                document.getElementById("ee").innerText = EE.sum().toFixed(table.internal_settings.round_threshold);
                document.getElementById("se").innerText = standard_error_slope(X, Y, E).toFixed(table.internal_settings.round_threshold);
            }

            function update_charts(table) {
                window.chart_data.datasets[0].data = table.internal_data.values.map(x => ({x: x.x, y: x.y}));
                window.chart_data.datasets[1].data = table.internal_data.values.map((x, i) => ({x: x.x, y: x.yy}));
                window.residual_plot_data.datasets[0].data = table.internal_data.values.map((x, i) => ({x: x.x, y: x.e}));
                window.scatter_chart.update();
                window.residual_plot.update();
            }

            function process_on_load() {
                let x = [60, 70, 80, 85, 95];
                let y = [70, 65, 70, 95, 85];

                let yy = linear_regression_apply(x, y);
                let data_table = create_data_table(x, y, yy);

                let html_table = create_html_table(data_table, {
                    table_id: "table-main",
                    enable_insert_remove_gui: true,
                    round_threshold: 4,
                    table_on_change_callback: handle_html_table_change
                });
                document.getElementById("display-html-table").appendChild(html_table);

                create_scatter_chart(data_table, "canvas-chart");
                create_residual_plot(data_table, "canvas-residual-plot");
                update_display_info(html_table);
                MathJax.typeset();
            }
        </script>
    </head>
    <body>
        <header>
            <div class="navbar bg-dark">
                <h2 class="text-white">Linear Regression</h2>
            </div>
        </header>
        <br />
        <main class="mx-4" role="main">
            <div id="display-text">
                <span>Correlation coefficient \(r\) is <span id="r"></span></span> <br />
                <span>\(\displaystyle\sum_{i=0}^{n-1}e_i =\) <span id="e"></span> where \(e = y - \hat{y}\)</span><br />
                <span>\(\displaystyle\sum_{i=0}^{n-1}{e_i}^2 =\) <span id="ee"></span></span> <br />
                <span>Standard error = <span id="se"></span></span> <br />
            </div>
            <div class="flex-container">
                <div id="display-html-table"></div>
                <div style="width:450px;" id="display-chart">
                    <canvas id="canvas-chart"></canvas>
                </div>
                <div style="width:350px;" id="display-residual-plot">
                    <canvas height="200" id="canvas-residual-plot"></canvas>
                </div>
            </div>
        </main>
        <footer class="text-muted bg-light">
            <div class="container">
                <p>Regression experiments based on learning from <a href="https://stattrek.com/">StatTrek.com</a></p>
            </div>
        </footer>
    </body>
</html> 